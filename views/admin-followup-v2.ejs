<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ติดตามลูกค้า | จัดการ AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Mali:wght@200;300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/admin-followup-v2.css" rel="stylesheet">
</head>

<body class="app-shell">
    <%- include('partials/admin-navbar', { activePage: 'followup' }) %>

        <div class="app-content">
            <!-- Summary Cards -->
            <div class="followup-summary-grid" id="followupSummaryCards">
                <div class="followup-summary-card">
                    <div class="followup-summary-icon icon-primary">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="followup-summary-content">
                        <div class="followup-summary-label">กำลังติดตาม</div>
                        <div class="followup-summary-value" id="metricActive">0</div>
                    </div>
                </div>
                <div class="followup-summary-card">
                    <div class="followup-summary-icon icon-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="followup-summary-content">
                        <div class="followup-summary-label">ส่งครบแล้ว</div>
                        <div class="followup-summary-value" id="metricCompleted">0</div>
                    </div>
                </div>
                <div class="followup-summary-card">
                    <div class="followup-summary-icon icon-muted">
                        <i class="fas fa-ban"></i>
                    </div>
                    <div class="followup-summary-content">
                        <div class="followup-summary-label">ยกเลิกแล้ว</div>
                        <div class="followup-summary-value" id="metricCanceled">0</div>
                    </div>
                </div>
                <div class="followup-summary-card">
                    <div class="followup-summary-icon icon-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="followup-summary-content">
                        <div class="followup-summary-label">ล้มเหลว</div>
                        <div class="followup-summary-value" id="metricFailed">0</div>
                    </div>
                </div>
            </div>

            <div class="followup-layout">
                <!-- Sidebar -->
                <aside class="followup-sidebar">
                    <!-- Page/Bot Selection -->
                    <div class="followup-filter-section">
                        <div class="followup-filter-title">
                            <i class="fas fa-layer-group"></i> เพจ/บอท
                        </div>
                        <div class="followup-page-list" id="followupPageList">
                            <div class="text-muted small text-center py-3">กำลังโหลด...</div>
                        </div>
                    </div>

                    <!-- Status Filter -->
                    <div class="followup-filter-section">
                        <div class="followup-filter-title">
                            <i class="fas fa-filter"></i> สถานะ
                        </div>
                        <div class="followup-status-pills" id="followupStatusPills">
                            <button class="followup-status-pill active" data-status="all">
                                <span class="pill-label"><span class="pill-dot"></span> ทั้งหมด</span>
                                <span class="pill-count" id="countAll">0</span>
                            </button>
                            <button class="followup-status-pill" data-status="active">
                                <span class="pill-label"><span class="pill-dot"></span> กำลังติดตาม</span>
                                <span class="pill-count" id="countActive">0</span>
                            </button>
                            <button class="followup-status-pill" data-status="completed">
                                <span class="pill-label"><span class="pill-dot"></span> ส่งครบแล้ว</span>
                                <span class="pill-count" id="countCompleted">0</span>
                            </button>
                            <button class="followup-status-pill" data-status="canceled">
                                <span class="pill-label"><span class="pill-dot"></span> ยกเลิกแล้ว</span>
                                <span class="pill-count" id="countCanceled">0</span>
                            </button>
                            <button class="followup-status-pill" data-status="failed">
                                <span class="pill-label"><span class="pill-dot"></span> ล้มเหลว</span>
                                <span class="pill-count" id="countFailed">0</span>
                            </button>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="followup-filter-section">
                        <div class="followup-filter-title">
                            <i class="fas fa-search"></i> ค้นหา
                        </div>
                        <div class="followup-search-wrapper">
                            <i class="fas fa-search followup-search-icon"></i>
                            <input type="text" class="followup-search-input" id="followupSearchInput"
                                placeholder="ชื่อลูกค้า, ID...">
                        </div>
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="followup-main">
                    <!-- Toolbar -->
                    <div class="followup-toolbar">
                        <div class="followup-toolbar-left">
                            <span class="followup-current-page" id="followupCurrentPage">เลือกเพจเพื่อดูรายการ</span>
                        </div>
                        <div class="followup-toolbar-actions">
                            <button class="followup-btn followup-btn-secondary" id="followupRefreshBtn">
                                <i class="fas fa-sync-alt"></i> รีเฟรช
                            </button>
                            <button class="followup-btn followup-btn-primary" id="followupSettingsBtn" disabled>
                                <i class="fas fa-cog"></i> ตั้งค่าเพจ
                            </button>
                        </div>
                    </div>

                    <!-- Schedule Preview -->
                    <div class="followup-schedule-card" id="followupScheduleCard">
                        <div class="followup-schedule-header">
                            <div class="followup-schedule-title">
                                <i class="fas fa-calendar-alt"></i> แผนการส่งข้อความอัตโนมัติ
                            </div>
                            <div class="followup-schedule-badges">
                                <span class="followup-badge badge-auto" id="badgeAutoSend">ปิดส่งอัตโนมัติ</span>
                                <span class="followup-badge badge-ai" id="badgeAnalysis">วิเคราะห์ AI: เปิด</span>
                            </div>
                        </div>
                        <div class="followup-schedule-timeline" id="followupTimeline">
                            <div class="text-muted small">เลือกเพจเพื่อดูแผนการส่ง</div>
                        </div>
                    </div>

                    <!-- Customer List -->
                    <div class="followup-list-card">
                        <div class="followup-list-container" id="followupListContainer">
                            <div class="followup-empty-state" id="followupEmptyState">
                                <div class="empty-icon"><i class="fas fa-user-clock"></i></div>
                                <div class="empty-title">ยังไม่มีลูกค้าที่ต้องติดตาม</div>
                                <div class="empty-desc">เลือกเพจจากด้านซ้ายเพื่อดูรายชื่อลูกค้า</div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal fade" id="followupSettingsModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalPageTitle">ตั้งค่าเพจติดตามลูกค้า</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-4">
                            <!-- Toggle Settings -->
                            <div class="col-12">
                                <div class="settings-toggle-group">
                                    <div class="settings-toggle-item">
                                        <div class="settings-toggle-info">
                                            <label class="settings-toggle-label">ส่งข้อความติดตามอัตโนมัติ</label>
                                            <div class="settings-toggle-desc">เปิดให้ระบบส่งข้อความติดตามตามเวลาที่กำหนด
                                            </div>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="modalAutoSend">
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    <div class="settings-toggle-item">
                                        <div class="settings-toggle-info">
                                            <label class="settings-toggle-label">วิเคราะห์การสั่งซื้อด้วย AI</label>
                                            <div class="settings-toggle-desc">AI จะวิเคราะห์ว่าลูกค้าซื้อแล้วหรือยัง
                                                ถ้าซื้อแล้วจะหยุดติดตาม</div>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="modalAnalysis">
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    <div class="settings-toggle-item">
                                        <div class="settings-toggle-info">
                                            <label class="settings-toggle-label">แสดงป้ายในหน้าแชท</label>
                                            <div class="settings-toggle-desc">แสดงป้ายติดตามในหน้าแชทแอดมิน</div>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="modalShowChat">
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    <div class="settings-toggle-item">
                                        <div class="settings-toggle-info">
                                            <label class="settings-toggle-label">แสดงในแดชบอร์ด</label>
                                            <div class="settings-toggle-desc">แสดงเพจนี้ในแดชบอร์ดติดตามลูกค้า</div>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="modalShowDashboard">
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AI Model -->
                            <div class="col-md-6">
                                <label class="form-label">โมเดล AI ที่ใช้วิเคราะห์</label>
                                <select class="form-select" id="modalAiModel">
                                    <option value="gpt-5-nano">GPT-5 Nano (ประหยัดสุด)</option>
                                    <option value="gpt-5-mini">GPT-5 Mini (แนะนำ)</option>
                                    <option value="gpt-5">GPT-5</option>
                                    <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                                    <option value="o3">O3 (ทรงพลังสุด)</option>
                                </select>
                            </div>

                            <!-- Prompt -->
                            <div class="col-12">
                                <label class="form-label">คำสั่งให้ AI วิเคราะห์ออเดอร์</label>
                                <textarea class="form-control" id="modalPrompt" rows="4"
                                    placeholder="อธิบายแนวทางให้ AI วิเคราะห์บทสนทนา..."></textarea>
                                <div class="form-text">ปล่อยว่างเพื่อใช้ค่าเริ่มต้น</div>
                            </div>

                            <!-- Rounds -->
                            <div class="col-12">
                                <div class="rounds-section">
                                    <div class="rounds-header">
                                        <div>
                                            <div class="rounds-title">ลำดับข้อความติดตาม</div>
                                            <div class="rounds-desc">ระบบจะส่งข้อความตามเวลาที่กำหนด
                                                โดยนับจากข้อความล่าสุดของลูกค้า</div>
                                        </div>
                                        <button type="button" class="followup-btn followup-btn-primary followup-btn-sm"
                                            id="modalAddRound">
                                            <i class="fas fa-plus"></i> เพิ่มรอบ
                                        </button>
                                    </div>
                                    <div class="rounds-list" id="modalRoundsList">
                                        <div class="text-muted small py-3">ยังไม่มีรอบการติดตาม</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" id="modalResetBtn">
                            <i class="fas fa-undo"></i> คืนค่าเริ่มต้น
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                        <button type="button" class="btn btn-primary" id="modalSaveBtn">
                            <i class="fas fa-save"></i> บันทึก
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Toast Container -->
        <div id="alertToastContainer" class="alert-toast-container"></div>

        <script>
            window.followUpDashboardConfig = {
                analysisEnabled: <%= (followUpConfig && followUpConfig.analysisEnabled) ? 'true' : 'false' %>,
                showDashboard: <%= (followUpConfig && followUpConfig.showDashboard) ? 'true' : 'false' %>,
                    defaultOrderPromptInstructions: <% - JSON.stringify((orderPromptDefaults && orderPromptDefaults.instructions) || "") %>,
                        orderPromptJsonSuffix: <% - JSON.stringify((orderPromptDefaults && orderPromptDefaults.jsonSuffix) || "") %>
        };
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/js/followup-dashboard-v2.js"></script>
</body>

</html>