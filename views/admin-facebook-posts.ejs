<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>โพสต์ FB & นโยบายคอมเมนต์ - ChatCenter AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/admin-navbar', { activePage: 'facebook-posts' }) %>

  <div class="container mt-4 mb-5">
    <div class="row justify-content-center">
      <div class="col-lg-11">
        <div class="mb-4">
          <h2 class="mb-2">
            <i class="fab fa-facebook text-primary me-2"></i>จัดการโพสต์ FB & นโยบายตอบคอมเมนต์
          </h2>
          <p class="text-muted mb-0">
            ระบบจะดึงโพสต์อัตโนมัติจาก webhook แล้วแยกรายเพจ ค่าเริ่มต้นต่อโพสต์ปิดไว้ก่อน ให้เปิดทีละโพสต์หรือกำหนดนโยบายค่าเริ่มต้นของเพจ
          </p>
        </div>

        <% if (typeof error !== 'undefined' && error) { %>
          <div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i><%= error %></div>
        <% } %>

        <div class="card shadow-sm mb-4">
          <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-semibold text-body">
                <i class="fas fa-layer-group me-2 text-primary"></i>เลือกเพจ
              </div>
              <div>
                <button id="syncPostsBtn" class="btn btn-outline-success btn-sm me-2">
                  <i class="fas fa-cloud-download-alt me-1"></i>ดึงโพสต์ล่าสุด
                </button>
                <button id="refreshPostsBtn" class="btn btn-outline-primary btn-sm">
                  <i class="fas fa-rotate-right me-1"></i>รีเฟรช
                </button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Facebook Page</label>
              <select id="facebookBotSelect" class="form-select">
                <% (facebookBots || []).forEach(function(bot) { %>
                  <option value="<%= bot._id %>" <%= selectedBotId && selectedBotId.toString() === bot._id.toString() ? 'selected' : '' %>>
                    <%= bot.name || bot.pageName || 'Facebook Page' %> (Page ID: <%= bot.pageId || 'ไม่ระบุ' %>)
                  </option>
                <% }) %>
              </select>
              <% if (!facebookBots || facebookBots.length === 0) { %>
                <small class="text-danger d-block mt-2">ยังไม่มี Facebook Page ในระบบ</small>
              <% } %>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-lg-5">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-light">
                <div class="fw-semibold text-body">
                  <i class="fas fa-sliders-h me-2 text-primary"></i>นโยบายค่าเริ่มต้นระดับเพจ
                </div>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">โหมดตอบ</label>
                  <select id="defaultMode" class="form-select">
                    <option value="off">ปิด (ไม่ตอบ)</option>
                    <option value="template">Template</option>
                    <option value="ai">AI</option>
                  </select>
                </div>
                <div class="mb-3" id="defaultTemplateGroup" style="display:none">
                  <label class="form-label">Template Message</label>
                  <textarea id="defaultTemplateMessage" class="form-control" rows="3" placeholder="ระบุข้อความตอบกลับ"></textarea>
                </div>
                <div class="mb-3" id="defaultAiGroup" style="display:none">
                  <label class="form-label">AI Model</label>
                  <input id="defaultAiModel" class="form-control" placeholder="เช่น gpt-4o-mini">
                  <label class="form-label mt-2">System Prompt</label>
                  <textarea id="defaultSystemPrompt" class="form-control" rows="3" placeholder="ระบุคำสั่งระบบ"></textarea>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="defaultPullToChat">
                  <label class="form-check-label" for="defaultPullToChat">ดึงเข้าแชท/ส่งข้อความส่วนตัว</label>
                </div>
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" id="defaultIsActive">
                  <label class="form-check-label" for="defaultIsActive">เปิดใช้งานนโยบายค่าเริ่มต้น</label>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <button id="saveDefaultPolicyBtn" class="btn btn-primary w-50">
                    <i class="fas fa-save me-2"></i>บันทึก
                  </button>
                  <div id="defaultPolicyStatus" class="small text-muted flex-fill"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-light">
                <div class="fw-semibold text-body">
                  <i class="fas fa-list me-2 text-primary"></i>โพสต์ที่ระบบจับอัตโนมัติ (ค่าเริ่มต้นต่อโพสต์ปิดไว้)
                </div>
              </div>
              <div class="card-body">
                <div id="postListStatus" class="text-muted small mb-2"></div>
                <div id="postList" class="vstack gap-3"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script id="facebookBotData" type="application/json">
    <%- JSON.stringify({ facebookBots, selectedBotId }) %>
  </script>
  <script src="/js/admin-facebook-posts.js"></script>
</body>
</html>
