<!DOCTYPE html>
<html lang="th">

<head>
    <% const isNewItem=typeof isNew !=='undefined' ? isNew : false; %>
        <% const pageTitle=isNewItem ? 'สร้างชุดข้อมูล' : 'แก้ไขชุดข้อมูล' ; %>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>
                <%= pageTitle %> - <%= instruction.parentInstructionName || instruction.title || 'ไม่มีชื่อ' %>
            </title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
            <link href="/css/style.css" rel="stylesheet">
            <style>
                body {
                    background: radial-gradient(circle at 20% 20%, #f4f7ff 0, #f4f7ff 20%, #eef1f8 60%, #e8edf7 100%);
                    font-family: "Mali", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                }

                .page-header-actions .btn {
                    min-width: 110px;
                }

                .table-builder-toolbar .btn {
                    min-width: 120px;
                }

                .sheet-shell {
                    border: 1px solid #cdd6e8;
                    border-radius: 14px;
                    background: linear-gradient(180deg, #ffffff 0%, #f7f9fc 100%);
                    box-shadow: 0 14px 40px rgba(16, 29, 57, 0.12);
                }

                .table-builder-wrapper {
                    max-height: none;
                    overflow: auto;
                    position: relative;
                    background: #f5f7fb;
                    border: 1px solid #cfd7e6;
                    border-radius: 12px;
                    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.65);
                }

                .table-builder-wrapper table {
                    min-width: 780px;
                    border-collapse: collapse;
                    border-spacing: 0;
                    width: 100%;
                    table-layout: fixed;
                    font-size: 14px;
                    line-height: 1.35;
                    margin: 0;
                    color: #1f2a44;
                }

                .table-builder-wrapper thead th,
                .table-builder-wrapper tbody td {
                    padding: 0;
                    border: 1px solid #d5deed;
                    background: #fff;
                    position: relative;
                    overflow: hidden;
                    word-break: break-word;
                }

                .table-builder-wrapper thead th {
                    position: sticky;
                    top: 0;
                    z-index: 3;
                    background: linear-gradient(180deg, #f3f6fb 0%, #eef2f8 100%) !important;
                    box-shadow: inset 0 -1px 0 #cfd7e6;
                    min-height: 52px;
                    font-weight: 700;
                    color: #1f2a44;
                    overflow: visible;
                }

                .table-header-control {
                    display: grid;
                    grid-template-columns: auto 1fr auto;
                    align-items: center;
                    gap: 8px;
                    width: 100%;
                    padding: 10px 14px 9px 10px;
                    position: relative;
                }

                .sheet-col-label {
                    min-width: 28px;
                    height: 28px;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 6px;
                    background: #e6ecf7;
                    color: #1f4e8c;
                    font-weight: 700;
                    font-size: 13px;
                    border: 1px solid #c9d3e7;
                }

                .table-header-input {
                    width: 100%;
                    min-width: 0;
                    height: 30px;
                    padding: 4px 8px;
                    border-radius: 6px;
                    border: 1px solid transparent;
                    background: transparent;
                    font-weight: 600;
                    color: #1f2a44;
                    transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
                }

                .table-header-input:hover {
                    border-color: #c3cde1;
                    background: #fff;
                }

                .table-header-input:focus {
                    border-color: #4c8dff;
                    box-shadow: 0 0 0 3px rgba(76, 141, 255, 0.2);
                    outline: none;
                    background: #fff;
                }

                .table-cell-input {
                    display: block;
                    width: 100%;
                    min-height: 40px;
                    padding: 8px 10px;
                    resize: none;
                    max-width: none;
                    min-width: 0;
                    font-family: inherit;
                    font-size: 14px;
                    line-height: 1.4;
                    box-sizing: border-box;
                    transition: box-shadow 0.12s ease, background-color 0.12s ease, height 0.12s ease;
                    border-radius: 0;
                    border: none;
                    background: transparent;
                    color: #1f2a44;
                    overflow: hidden;
                }

                /* Excel-like active cell highlighting */
                .table-cell-input:focus {
                    box-shadow: inset 0 0 0 2px #4c8dff;
                    outline: none;
                    z-index: 1;
                    position: relative;
                    background: #fff;
                }

                .table-cell-input.is-active-cell {
                    box-shadow: inset 0 0 0 2px #4c8dff;
                    position: relative;
                    background: #fff;
                }

                .table-cell-input:hover:not(:focus) {
                    background-color: #f9fbff;
                }

                .table-cell-input::-webkit-resizer {
                    display: none;
                }

                .table-builder-wrapper .table-actions-col {
                    width: 56px;
                    min-width: 56px;
                    text-align: center;
                    background: #f3f6fb;
                    padding: 6px 8px;
                }

                .sticky-header {
                    position: sticky;
                    top: 0;
                    z-index: 4;
                }

                .table-builder-wrapper .table-row-number {
                    width: 48px;
                    min-width: 48px;
                    max-width: 48px;
                    width: 48px !important;
                    min-width: 48px !important;
                    max-width: 48px !important;
                    background: linear-gradient(180deg, #eef2f8 0%, #e2e8f3 100%);
                    text-align: center;
                    position: sticky;
                    left: 0;
                    z-index: 5;
                    border-right: 1px solid #cfd7e6;
                    font-weight: 700;
                    color: #5c6580;
                    padding: 6px;
                    vertical-align: middle;
                }

                .table-builder-wrapper .row-number-cell {
                    width: 48px;
                    min-width: 48px;
                    max-width: 48px;
                    width: 48px !important;
                    min-width: 48px !important;
                    max-width: 48px !important;
                    background: linear-gradient(180deg, #f9fafc 0%, #eef2f8 100%);
                    position: sticky;
                    left: 0;
                    z-index: 4;
                    text-align: center;
                    color: #5c6580;
                    font-weight: 600;
                    border-right: 1px solid #cfd7e6;
                    padding: 0;
                    vertical-align: middle;
                    overflow: hidden;
                }

                .table-builder-wrapper td[data-col-index] {
                    cursor: text;
                }

                .row-number-inner {
                    position: relative;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 6px;
                    height: 100%;
                }

                .row-resizer {
                    position: absolute;
                    left: 6px;
                    right: 6px;
                    bottom: -3px;
                    height: 8px;
                    cursor: row-resize;
                    background: transparent;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                }

                .row-resizer::after {
                    content: '';
                    width: 24px;
                    height: 2px;
                    background: #4c8dff;
                    border-radius: 2px;
                    opacity: 0.6;
                    transition: opacity 0.15s ease;
                }

                .row-resizer:hover::after {
                    opacity: 1;
                }

                .table-builder-wrapper tr:hover td:not(.row-number-cell):not(.table-actions-col) {
                    background: #f6f9ff;
                }

                .table-builder-wrapper tr.active-row td:not(.row-number-cell):not(.table-actions-col) {
                    background: #eaf2ff;
                }

                .table-builder-wrapper th.active-col,
                .table-builder-wrapper td.active-col {
                    background: #e7efff !important;
                }

                .column-resizer {
                    position: absolute;
                    top: 4px;
                    right: -6px;
                    width: 12px;
                    cursor: col-resize;
                    border-radius: 6px;
                    height: calc(100% - 8px);
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    background: transparent;
                    transition: background-color 0.15s ease;
                }

                .column-resizer:hover {
                    background: rgba(76, 141, 255, 0.08);
                }

                .column-resizer::after {
                    content: '';
                    width: 2px;
                    height: 16px;
                    background: #4c8dff;
                    border-radius: 2px;
                    opacity: 0.65;
                    transition: opacity 0.15s ease;
                }

                .column-resizer:hover::after {
                    opacity: 1;
                }

                .cell-flyout {
                    position: absolute;
                    z-index: 1200;
                    background: #fff;
                    border: 2px solid #4c8dff;
                    border-radius: 10px;
                    box-shadow: 0 12px 30px rgba(16, 29, 57, 0.2);
                    padding: 8px;
                    min-width: 220px;
                    max-width: 520px;
                    min-height: 80px;
                    max-height: 360px;
                    overflow: hidden;
                }

                .cell-flyout textarea {
                    width: 100%;
                    min-height: 80px;
                    max-height: 320px;
                    resize: vertical;
                    border: none;
                    outline: none;
                    background: transparent;
                    font-family: inherit;
                    font-size: 14px;
                    line-height: 1.45;
                    color: #1f2a44;
                }

                .table-toolbar-subtext {
                    color: #6c7685;
                    font-size: 13px;
                }

                .table-hint-pill {
                    background: #e6f0ff;
                    color: #0d6efd;
                    border: 1px solid #c8dcff;
                    border-radius: 999px;
                    padding: 3px 8px;
                    font-size: 12px;
                    font-weight: 600;
                }

                .sheet-toolbar {
                    background: #eef2f8;
                    border: 1px solid #cfd7e6;
                    border-radius: 12px;
                    padding: 10px 12px;
                    margin-bottom: 10px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    gap: 12px;
                    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
                }

                .sheet-toolbar .sheet-label {
                    font-weight: 700;
                    color: #1f2a44;
                    letter-spacing: 0.2px;
                }

                .sheet-pill {
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 4px 10px;
                    background: #e5eaf5;
                    border-radius: 999px;
                    color: #44506b;
                    font-weight: 600;
                    font-size: 12px;
                    border: 1px solid #d5deed;
                }

                .parent-instruction-badge {
                    background: var(--primary-color);
                    color: white;
                    padding: 4px 12px;
                    border-radius: 4px;
                    font-size: 0.85rem;
                    display: inline-block;
                    margin-bottom: 16px;
                }

                /* Context Menu Styles */
                .table-context-menu {
                    position: absolute;
                    background: white;
                    border: 1px solid #dee2e6;
                    border-radius: 4px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                    z-index: 1000;
                    min-width: 180px;
                    display: none;
                }

                .table-context-menu.show {
                    display: block;
                }

                .context-menu-item {
                    padding: 8px 16px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-size: 14px;
                }

                .context-menu-item:hover {
                    background-color: #f8f9fa;
                }

                .context-menu-item i {
                    width: 16px;
                }

                .context-menu-divider {
                    height: 1px;
                    background-color: #dee2e6;
                    margin: 4px 0;
                }

                .context-menu-shortcut {
                    margin-left: auto;
                    font-size: 12px;
                    color: #6c757d;
                }

                /* Keyboard shortcuts help tooltip */
                .shortcuts-help-btn {
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    width: 48px;
                    height: 48px;
                    border-radius: 50%;
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                    cursor: pointer;
                    z-index: 100;
                    transition: transform 0.2s;
                }

                .shortcuts-help-btn:hover {
                    transform: scale(1.1);
                }

                .shortcuts-tooltip {
                    position: fixed;
                    bottom: 80px;
                    right: 20px;
                    background: white;
                    border: 1px solid #dee2e6;
                    border-radius: 8px;
                    padding: 16px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    z-index: 101;
                    min-width: 300px;
                    display: none;
                }

                .shortcuts-tooltip.show {
                    display: block;
                }

                .shortcuts-tooltip h6 {
                    margin: 0 0 12px 0;
                    font-weight: 600;
                }

                .shortcut-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 6px 0;
                    font-size: 13px;
                }

                .shortcut-key {
                    background: #f8f9fa;
                    padding: 2px 8px;
                    border-radius: 3px;
                    font-family: monospace;
                    font-size: 12px;
                    border: 1px solid #dee2e6;
                }

                /* Status bar */
                .table-status-bar {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 8px 12px;
                    background: #eef2f8;
                    border-top: 1px solid #cfd7e6;
                    font-size: 13px;
                    color: #526078;
                    border-radius: 0 0 12px 12px;
                    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
                }

                .status-chip {
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 5px 10px;
                    border-radius: 10px;
                    background: #e7ecf6;
                    color: #2f3b52;
                    font-weight: 600;
                    font-size: 12px;
                    border: 1px solid #d5deed;
                }

                .status-chip i {
                    color: #4c8dff;
                }

                .table-quick-actions .btn {
                    border-radius: 8px;
                }
            </style>
</head>

<body class="app-shell">
    <%- include('partials/admin-navbar', { activePage: 'dashboard' }) %>

        <div class="app-content">
        <div class="container-fluid mt-0">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <div class="parent-instruction-badge">
                        <i class="fas fa-folder me-1"></i>
                        <%= instruction.parentInstructionName %>
                    </div>
                    <h4 class="mb-0">
                        <%= pageTitle %>
                    </h4>
                </div>
                <a href="/admin/dashboard" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> กลับแดชบอร์ด
                </a>
            </div>

            <div class="row g-4">
                <div class="col-12">
                    <% const formAction=isNewItem ? '/admin/instructions-v2/' + instructionId + '/data-items/new'
                        : '/admin/instructions-v2/' + instructionId + '/data-items/' + itemId + '/edit' ; %>
                        <form id="editDataItemForm" method="POST" action="<%= formAction %>" class="needs-validation"
                            novalidate>
                            <div class="card shadow-sm mb-4">
                                <div class="card-body">
                                    <div class="mb-3 text-muted small">
                                        <% if (isNewItem) { %>
                                            รหัสชุดข้อมูลจะถูกสร้างอัตโนมัติเมื่อบันทึก
                                            <% } else { %>
                                                รหัสชุดข้อมูล: <span class="text-break">
                                                    <%= itemId %>
                                                </span>
                                                <% } %>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label" for="instructionType">
                                            ประเภทข้อมูล
                                        </label>
                                        <select class="form-select" id="instructionType" name="type">
                                            <option value="text" <%=instruction.type==='text' ? 'selected' : '' %>
                                                >ข้อความ (Text)</option>
                                            <option value="table" <%=instruction.type==='table' ? 'selected' : '' %>
                                                >ตาราง (Table)</option>
                                        </select>
                                        <div class="form-text">
                                            เลือกรูปแบบข้อมูลที่เหมาะกับชุดข้อมูลนี้
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label" for="instructionTitle">
                                            ชื่อชุดข้อมูล <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="instructionTitle" name="title"
                                            value="<%= instruction.title || '' %>" required
                                            placeholder="เช่น ข้อมูลสินค้า / ขั้นตอนบริการ / โปรโมชั่นล่าสุด">
                                    </div>

                                    <div id="textEditorSection" class="mb-3">
                                        <label class="form-label" for="instructionContent">
                                            เนื้อหาข้อความ
                                        </label>
                                        <textarea class="form-control" id="instructionContent" name="content" rows="10"
                                            placeholder="กรอกข้อมูลที่ต้องการให้ AI ใช้ตอบกลับให้ลูกค้า"><%= instruction.content || '' %></textarea>
                                        <div class="form-text d-flex justify-content-between">
                                            <span>
                                                <i class="fas fa-lightbulb me-1 text-warning"></i>
                                                เขียนให้กระชับและเข้าใจง่าย เพื่อให้ AI นำไปใช้ตอบได้แม่นยำ
                                            </span>
                                            <span id="contentCharCount">0</span>
                                        </div>
                                    </div>

                                    <div id="tableEditorSection" class="mb-3" style="display: none;">
                                        <div
                                            class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                                            <div>
                                                <label class="form-label mb-0">
                                                    ตั้งค่าตารางข้อมูล
                                                </label>
                                                <div class="form-text">
                                                    เพิ่ม/ลบคอลัมน์และแถวตามโครงสร้างข้อมูลที่ต้องการ
                                                </div>
                                            </div>
                                            <div class="table-builder-toolbar btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary" id="addColumnBtn">
                                                    <i class="fas fa-plus me-1"></i> เพิ่มคอลัมน์
                                                </button>
                                                <button type="button" class="btn btn-outline-primary" id="addRowBtn">
                                                    <i class="fas fa-plus me-1"></i> เพิ่มแถว
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" id="clearTableBtn">
                                                    <i class="fas fa-trash me-1"></i> ล้างตาราง
                                                </button>
                                            </div>
                                        </div>

                                        <div class="d-flex flex-wrap align-items-center gap-2 table-toolbar-subtext mb-2">
                                            <span class="table-hint-pill">
                                                <i class="fas fa-clipboard-list me-1"></i> Paste จาก Excel / Google Sheets ได้ทันที
                                            </span>
                                            <span>ใช้ Tab / Shift+Tab / Enter เพื่อเลื่อนไปยังเซลล์ถัดไป • Shift+Enter เพื่อขึ้นบรรทัดใหม่ในเซลล์</span>
                                        </div>

                                        <div class="card border-0 shadow-sm table-builder-card sheet-shell">
                                            <div class="card-body">
                                                <div class="sheet-toolbar">
                                                    <div class="d-flex align-items-center gap-2 flex-wrap">
                                        <span class="sheet-label"><i class="fas fa-table me-1 text-primary"></i>Dataset Sheet</span>
                                                        <span class="sheet-pill">
                                                            <i class="fas fa-hand-pointer text-primary"></i> ลากขอบสีน้ำเงินเพื่อปรับความกว้างคอลัมน์
                                                        </span>
                                                        <span class="sheet-pill">
                                                            <i class="fas fa-keyboard text-primary"></i> Enter ลงแถวใหม่ • Shift+Enter ขึ้นบรรทัดใหม่ในเซลล์
                                                        </span>
                                                    </div>
                                                    <div class="d-flex align-items-center gap-2">
                                                        <span class="badge bg-light text-secondary border">
                                                            โหมดแก้ไขตาราง
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="table-responsive table-builder-wrapper">
                                                    <table class="sheet-grid" id="instructionTableBuilder">
                                                        <colgroup id="tableColGroup"></colgroup>
                                                        <thead>
                                                            <tr id="tableHeaderRow"></tr>
                                                        </thead>
                                                        <tbody id="tableBodyRows"></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="table-status-bar">
                                                <div class="d-flex flex-wrap align-items-center gap-2">
                                                    <span class="status-chip" id="tableStatusSummary">
                                                        <i class="fas fa-table"></i>
                                                        <span>0 คอลัมน์ • 0 แถว</span>
                                                    </span>
                                                    <span class="status-chip" id="tableSelectionSummary">
                                                        <i class="fas fa-crosshairs"></i>
                                                        <span>คลิกเซลล์เพื่อแก้ไข</span>
                                                    </span>
                                                </div>
                                                <div class="table-quick-actions d-flex align-items-center gap-2">
                                                    <button type="button" class="btn btn-light btn-sm" id="quickAddRowBtn">
                                                        <i class="fas fa-plus me-1"></i> เพิ่มแถวถัดไป
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="copyTsvBtn">
                                                        <i class="fas fa-copy me-1"></i> คัดลอกเป็น TSV
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" id="tableDataInput" name="tableData">
                                    </div>

                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <a href="/admin/dashboard" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i> ยกเลิก
                                </a>
                                <button type="submit" class="btn btn-primary" id="saveInstructionBtn">
                                    <i class="fas fa-save me-1"></i>
                                    <%= isNewItem ? 'สร้างชุดข้อมูล' : 'บันทึกการแก้ไข' %>
                                </button>
                            </div>
                        </form>
                </div>

            </div>
        </div>
        </div>

        <!-- Context Menu -->
        <div id="tableContextMenu" class="table-context-menu">
            <div class="context-menu-item" data-action="copy">
                <i class="fas fa-copy"></i>
                <span>คัดลอก</span>
                <span class="context-menu-shortcut">Ctrl+C</span>
            </div>
            <div class="context-menu-item" data-action="cut">
                <i class="fas fa-cut"></i>
                <span>ตัด</span>
                <span class="context-menu-shortcut">Ctrl+X</span>
            </div>
            <div class="context-menu-item" data-action="paste">
                <i class="fas fa-paste"></i>
                <span>วาง</span>
                <span class="context-menu-shortcut">Ctrl+V</span>
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item" data-action="delete">
                <i class="fas fa-eraser"></i>
                <span>ล้างเซลล์</span>
                <span class="context-menu-shortcut">Delete</span>
            </div>
        </div>

        <!-- Shortcuts Help Button & Tooltip -->
        <button type="button" class="shortcuts-help-btn" id="shortcutsHelpBtn" title="คีย์ลัด">
            <i class="fas fa-keyboard"></i>
        </button>
        <div class="shortcuts-tooltip" id="shortcutsTooltip">
            <h6><i class="fas fa-keyboard me-2"></i>คีย์ลัดที่ใช้ได้</h6>
            <div class="shortcut-item">
                <span>เคลื่อนที่ซ้าย/ขวา/ขึ้น/ลง</span>
                <span class="shortcut-key">← → ↑ ↓</span>
            </div>
            <div class="shortcut-item">
                <span>ช่องถัดไป</span>
                <span class="shortcut-key">Tab</span>
            </div>
            <div class="shortcut-item">
                <span>ช่องก่อนหน้า</span>
                <span class="shortcut-key">Shift+Tab</span>
            </div>
                    <div class="shortcut-item">
                        <span>ลงแถวถัดไป</span>
                        <span class="shortcut-key">Enter</span>
                    </div>
                    <div class="shortcut-item">
                        <span>ขึ้นบรรทัดใหม่ในเซลล์เดิม</span>
                        <span class="shortcut-key">Shift+Enter</span>
                    </div>
            <div class="shortcut-item">
                <span>คัดลอก</span>
                <span class="shortcut-key">Ctrl+C</span>
            </div>
            <div class="shortcut-item">
                <span>ตัด</span>
                <span class="shortcut-key">Ctrl+X</span>
            </div>
            <div class="shortcut-item">
                <span>วาง</span>
                <span class="shortcut-key">Ctrl+V</span>
            </div>
            <div class="shortcut-item">
                <span>ล้างเซลล์</span>
                <span class="shortcut-key">Delete</span>
            </div>
            <div class="shortcut-item">
                <span>ยกเลิกการเปลี่ยนแปลง</span>
                <span class="shortcut-key">Ctrl+Z</span>
            </div>
            <div class="shortcut-item">
                <span>ทำซ้ำการเปลี่ยนแปลง</span>
                <span class="shortcut-key">Ctrl+Y</span>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        </div> <!-- /app-content -->

        <script>
            const initialInstruction = {
                id: '<%= instruction._id.toString() %>',
                instructionId: <%- JSON.stringify(instruction.instructionId || '') %>,
                type: '<%= instruction.type %>',
                title: <%- JSON.stringify(instruction.title || '') %>,
                content: <%- JSON.stringify(instruction.content || '') %>,
                data: <%- JSON.stringify(instruction.data || null) %>,
                createdAt: '<%= instruction.createdAt ? new Date(instruction.createdAt).toISOString() : '' %>',
                updatedAt: '<%= instruction.updatedAt ? new Date(instruction.updatedAt).toISOString() : '' %>'
        };

            // Undo/Redo System
            const undoRedoManager = (() => {
                let undoStack = [];
                let redoStack = [];
                const MAX_HISTORY = 50;

                return {
                    saveState(state) {
                        undoStack.push(JSON.parse(JSON.stringify(state)));
                        if (undoStack.length > MAX_HISTORY) {
                            undoStack.shift();
                        }
                        redoStack = [];
                    },
                    undo() {
                        if (undoStack.length > 0) {
                            const state = undoStack.pop();
                            redoStack.push(state);
                            return state;
                        }
                        return null;
                    },
                    redo() {
                        if (redoStack.length > 0) {
                            const state = redoStack.pop();
                            undoStack.push(state);
                            return state;
                        }
                        return null;
                    },
                    canUndo() {
                        return undoStack.length > 0;
                    },
                    canRedo() {
                        return redoStack.length > 0;
                    }
                };
            })();

            // Clipboard manager for copy/cut/paste
            let copiedCellData = null;


            const instructionTableBuilder = (() => {
                let isInitialized = false;
                let columns = ['คอลัมน์ 1', 'คอลัมน์ 2'];
                let rows = [
                    ['', ''],
                    ['', ''],
                    ['', '']
                ];
                const DEFAULT_COLUMN_WIDTH = 220;
                const MIN_COLUMN_WIDTH = 10;
                const DEFAULT_ROW_HEIGHT = 44;
                const MIN_ROW_HEIGHT = 32;
                let columnSizes = new Array(columns.length).fill(DEFAULT_COLUMN_WIDTH);
                let rowSizes = new Array(rows.length).fill(DEFAULT_ROW_HEIGHT);
                let activeCell = { row: null, col: null };

                const refs = {
                    colGroup: null,
                    headerRow: null,
                    bodyRows: null,
                    addColumnBtn: null,
                    addRowBtn: null,
                    clearBtn: null,
                    hiddenInput: null
                };

                const columnLabel = (index) => {
                    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    let num = index;
                    let label = '';
                    while (num >= 0) {
                        label = letters[num % 26] + label;
                        num = Math.floor(num / 26) - 1;
                    }
                    return label;
                };

                const escapeHtml = (value) => {
                    if (value === null || value === undefined) return '';
                    return String(value)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                };

                const ensureColumnDefaults = () => {
                    columns = columns.map((col, index) => {
                        const name = (col || '').trim();
                        return name || `คอลัมน์ ${index + 1}`;
                    });
                    syncColumnSizesLength();
                };

                const ensureRowWidths = () => {
                    rows = rows.map(row => {
                        const nextRow = Array.isArray(row) ? [...row] : [];
                        while (nextRow.length < columns.length) {
                            nextRow.push('');
                        }
                        if (nextRow.length > columns.length) {
                            nextRow.length = columns.length;
                        }
                        return nextRow;
                    });
                };

                const highlightActiveCell = () => {
                    if (!refs.bodyRows) return;
                    refs.bodyRows.querySelectorAll('tr').forEach(tr => {
                        const rowIndex = Number(tr.getAttribute('data-row-index'));
                        tr.classList.toggle('active-row', Number.isInteger(activeCell.row) && rowIndex === activeCell.row);
                    });
                    refs.bodyRows.querySelectorAll('td[data-col-index]').forEach(td => {
                        const colIndex = Number(td.getAttribute('data-col-index'));
                        td.classList.toggle('active-col', Number.isInteger(activeCell.col) && colIndex === activeCell.col);
                    });
                    if (refs.headerRow) {
                        refs.headerRow.querySelectorAll('th[data-col-index]').forEach(th => {
                            const colIndex = Number(th.getAttribute('data-col-index'));
                            th.classList.toggle('active-col', Number.isInteger(activeCell.col) && colIndex === activeCell.col);
                        });
                    }
                    refs.bodyRows.querySelectorAll('.table-cell-input').forEach(input => {
                        const rowIndex = Number(input.getAttribute('data-row-index'));
                        const colIndex = Number(input.getAttribute('data-col-index'));
                        const isActive = Number.isInteger(activeCell.row) && Number.isInteger(activeCell.col) && rowIndex === activeCell.row && colIndex === activeCell.col;
                        input.classList.toggle('is-active-cell', isActive);
                    });
                };

                const setActiveCell = (rowIndex, colIndex) => {
                    if (!Number.isInteger(rowIndex) || !Number.isInteger(colIndex)) return;
                    activeCell = { row: rowIndex, col: colIndex };
                    highlightActiveCell();
                    updatePreview();
                };

                const clampActiveCell = () => {
                    const maxRow = rows.length ? rows.length - 1 : null;
                    const maxCol = columns.length ? columns.length - 1 : null;
                    if (maxRow !== null) {
                        if (!Number.isInteger(activeCell.row) || activeCell.row > maxRow) {
                            activeCell.row = Math.max(0, maxRow);
                        }
                    }
                    if (maxCol !== null) {
                        if (!Number.isInteger(activeCell.col) || activeCell.col > maxCol) {
                            activeCell.col = Math.max(0, maxCol);
                        }
                    }
                };

                const renderHeader = () => {
                    if (!refs.headerRow) return;
                    ensureColumnDefaults();
                    renderColGroup();
                    refs.headerRow.innerHTML = `
                        <th scope="col" class="table-row-number sticky-header">#</th>
                        ${columns.map((columnName, index) => `
                            <th scope="col" class="sticky-header" data-col-index="${index}">
                                <div class="table-header-control">
                                    <span class="sheet-col-label">${columnLabel(index)}</span>
                                    <input
                                        type="text"
                                        class="table-header-input"
                                        value="${escapeHtml(columnName)}"
                                        data-col-index="${index}"
                                        aria-label="ชื่อคอลัมน์ที่ ${index + 1}">
                                    <span class="column-resizer" data-resize-col="${index}" title="ปรับความกว้างคอลัมน์"></span>
                                    ${columns.length > 1 ? `
                                        <button type="button" class="btn btn-link btn-sm text-danger p-0 remove-column-btn" data-remove-column="${index}" title="ลบคอลัมน์นี้">
                                            <i class="fas fa-times-circle"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </th>
                        `).join('')}
                        <th scope="col" class="text-center table-actions-col sticky-header">
                            <i class="fas fa-ellipsis-h text-muted"></i>
                        </th>
                    `;

                    refs.headerRow.querySelectorAll('.table-header-input').forEach(input => {
                        const colIndex = Number(input.getAttribute('data-col-index'));
                        if (!Number.isInteger(colIndex)) return;
                        applyColumnWidthToElements(colIndex);
                    });

                    refs.headerRow.querySelectorAll('.table-header-input').forEach(input => {
                        input.addEventListener('input', event => {
                            const colIndex = Number(event.target.getAttribute('data-col-index'));
                            if (Number.isInteger(colIndex) && colIndex >= 0 && colIndex < columns.length) {
                                columns[colIndex] = event.target.value;
                            }
                            updatePreview();
                        });
                    });

                    refs.headerRow.querySelectorAll('.column-resizer').forEach(handle => {
                        handle.addEventListener('mousedown', (e) => {
                            const colIndex = Number(handle.getAttribute('data-resize-col'));
                            startColumnResize(colIndex, e.clientX);
                        });
                    });

                    refs.headerRow.querySelectorAll('.remove-column-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const colIndex = Number(btn.getAttribute('data-remove-column'));
                            if (!Number.isInteger(colIndex)) return;
                            if (columns.length <= 1) {
                                showAlert('ต้องมีคอลัมน์อย่างน้อย 1 คอลัมน์', 'warning');
                                return;
                            }
                            columns.splice(colIndex, 1);
                            if (columnSizes.length > colIndex) {
                                columnSizes.splice(colIndex, 1);
                            }
                            rows.forEach(row => row.splice(colIndex, 1));
                            syncColumnSizesLength();
                            render();
                            updatePreview();
                        });
                    });
                };

                const renderBody = () => {
                    if (!refs.bodyRows) return;
                    ensureRowWidths();
                    syncRowSizesLength();
                    refs.bodyRows.innerHTML = rows.map((row, rowIndex) => {
                        const rowHeight = getStoredRowHeight(rowIndex);
                        return `
                    <tr data-row-index="${rowIndex}">
                        <td class="row-number-cell" data-row-index="${rowIndex}" style="height:${rowHeight}px">
                            <div class="row-number-inner">
                                <span>${rowIndex + 1}</span>
                                <span class="row-resizer" data-resize-row="${rowIndex}" title="ปรับความสูงแถว"></span>
                            </div>
                        </td>
                        ${row.map((cellValue, colIndex) => `
                            <td data-col-index="${colIndex}" data-row-index="${rowIndex}">
                                <textarea
                                    class="table-cell-input"
                                    data-row-index="${rowIndex}"
                                    data-col-index="${colIndex}"
                                    style="height:${rowHeight}px">${escapeHtml(cellValue)}</textarea>
                            </td>
                        `).join('')}
                        <td class="text-center table-actions-col" style="height:${rowHeight}px">
                            <button type="button" class="btn btn-link text-danger btn-sm remove-row-btn" data-remove-row="${rowIndex}" title="ลบแถวนี้">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
                    }).join('');

                    refs.bodyRows.querySelectorAll('.table-cell-input').forEach(input => {
                        const rowIndex = Number(input.getAttribute('data-row-index'));
                        const colIndex = Number(input.getAttribute('data-col-index'));
                        if (Number.isInteger(colIndex)) {
                            applyColumnWidthToElements(colIndex);
                        }

                        if (Number.isInteger(rowIndex) && Number.isInteger(colIndex)) {
                            input.addEventListener('focus', () => {
                                setActiveCell(rowIndex, colIndex);
                                showCellFlyout(input);
                            });
                        }

                        input.addEventListener('input', event => {
                            const rowIndex = Number(event.target.getAttribute('data-row-index'));
                            const colIndex = Number(event.target.getAttribute('data-col-index'));
                            if (!Number.isInteger(rowIndex) || !Number.isInteger(colIndex)) return;
                            if (!rows[rowIndex]) rows[rowIndex] = [];
                            rows[rowIndex][colIndex] = event.target.value;
                            showCellFlyout(event.target);
                            updatePreview();
                        });

                        input.addEventListener('blur', (event) => {
                            const flyout = ensureCellFlyout();
                            if (!flyout || event.relatedTarget !== flyout.input) {
                                hideCellFlyout();
                            }
                        });

                        input.addEventListener('keydown', event => {
                            const currentRow = Number(event.target.getAttribute('data-row-index'));
                            const currentCol = Number(event.target.getAttribute('data-col-index'));

                            // Tab: Move right
                            if (event.key === 'Tab' && !event.shiftKey) {
                                event.preventDefault();
                                const nextCol = currentCol + 1;
                                if (nextCol < columns.length) {
                                    const target = refs.bodyRows.querySelector(`.table-cell-input[data-row-index="${currentRow}"][data-col-index="${nextCol}"]`);
                                    if (target) target.focus();
                                } else if (currentRow + 1 < rows.length) {
                                    const target = refs.bodyRows.querySelector(`.table-cell-input[data-row-index="${currentRow + 1}"][data-col-index="0"]`);
                                    if (target) target.focus();
                                }
                            }
                            // Shift+Tab: Move left
                            else if (event.key === 'Tab' && event.shiftKey) {
                                event.preventDefault();
                                const prevCol = currentCol - 1;
                                if (prevCol >= 0) {
                                    const target = refs.bodyRows.querySelector(`.table-cell-input[data-row-index="${currentRow}"][data-col-index="${prevCol}"]`);
                                    if (target) target.focus();
                                } else if (currentRow > 0) {
                                    const target = refs.bodyRows.querySelector(`.table-cell-input[data-row-index="${currentRow - 1}"][data-col-index="${columns.length - 1}"]`);
                                    if (target) target.focus();
                                }
                            }
                            // Delete: Clear cell
                            else if (event.key === 'Delete') {
                                if (event.target.selectionStart === event.target.selectionEnd) {
                                    event.preventDefault();
                                    undoRedoManager.saveState({ columns: columns, rows: JSON.parse(JSON.stringify(rows)) });
                                    rows[currentRow][currentCol] = '';
                                    event.target.value = '';
                                    updatePreview();
                                }
                            }
                            // Ctrl+C: Copy
                            else if ((event.ctrlKey || event.metaKey) && event.key === 'c') {
                                const value = event.target.value;
                                copiedCellData = value;
                                navigator.clipboard.writeText(value).catch(() => { });
                                showAlert('คัดลอกแล้ว', 'success');
                            }
                            // Ctrl+X: Cut
                            else if ((event.ctrlKey || event.metaKey) && event.key === 'x') {
                                const value = event.target.value;
                                copiedCellData = value;
                                navigator.clipboard.writeText(value).catch(() => { });
                                undoRedoManager.saveState({ columns: columns, rows: JSON.parse(JSON.stringify(rows)) });
                                rows[currentRow][currentCol] = '';
                                event.target.value = '';
                                updatePreview();
                                showAlert('ตัดแล้ว', 'success');
                            }
                            // Ctrl+Z: Undo
                            else if ((event.ctrlKey || event.metaKey) && event.key === 'z' && !event.shiftKey) {
                                event.preventDefault();
                                const state = undoRedoManager.undo();
                                if (state) {
                                    columns = state.columns || columns;
                                    rows = state.rows || rows;
                                    render();
                                    updatePreview();
                                    showAlert('ยกเลิกการเปลี่ยนแปลง', 'info');
                                }
                            }
                            // Ctrl+Y: Redo
                            else if ((event.ctrlKey || event.metaKey) && event.key === 'y') {
                                event.preventDefault();
                                const state = undoRedoManager.redo();
                                if (state) {
                                    columns = state.columns || columns;
                                    rows = state.rows || rows;
                                    render();
                                    updatePreview();
                                    showAlert('ทำซ้ำการเปลี่ยนแปลง', 'info');
                                }
                            }
                            // Arrow keys navigation
                            else if (event.key === 'ArrowUp') {
                                event.preventDefault();
                                const target = refs.bodyRows.querySelector(`.table-cell-input[data-row-index="${currentRow - 1}"][data-col-index="${currentCol}"]`);
                                if (target) target.focus();
                            } else if (event.key === 'ArrowDown') {
                                event.preventDefault();
                                const target = refs.bodyRows.querySelector(`.table-cell-input[data-row-index="${currentRow + 1}"][data-col-index="${currentCol}"]`);
                                if (target) target.focus();
                            } else if (event.key === 'ArrowLeft' && event.target.selectionStart === 0) {
                                event.preventDefault();
                                const target = refs.bodyRows.querySelector(`.table-cell-input[data-row-index="${currentRow}"][data-col-index="${currentCol - 1}"]`);
                                if (target) target.focus();
                            } else if (event.key === 'ArrowRight' && event.target.selectionStart === event.target.value.length) {
                                event.preventDefault();
                                const target = refs.bodyRows.querySelector(`.table-cell-input[data-row-index="${currentRow}"][data-col-index="${currentCol + 1}"]`);
                                if (target) target.focus();
                            } else if (event.key === 'Enter' && !event.shiftKey) {
                                event.preventDefault();
                                const target = refs.bodyRows.querySelector(`.table-cell-input[data-row-index="${currentRow + 1}"][data-col-index="${currentCol}"]`);
                                if (target) {
                                    target.focus();
                                } else {
                                    addRow();
                                }
                            }
                        });

                        input.addEventListener('paste', event => {
                            event.preventDefault();
                            const clipboardData = (event.clipboardData || window.clipboardData).getData('text');
                            if (!clipboardData) return;

                            const pasteRows = clipboardData.split(/\r\n|\n|\r/).map(row => row.split('\t'));
                            if (pasteRows.length === 0) return;

                            const startRow = Number(event.target.getAttribute('data-row-index'));
                            const startCol = Number(event.target.getAttribute('data-col-index'));

                            // Expand table if needed
                            const neededRows = startRow + pasteRows.length;
                            while (rows.length < neededRows) {
                                rows.push(new Array(columns.length).fill(''));
                                rowSizes.push(DEFAULT_ROW_HEIGHT);
                            }

                            const maxColsNeeded = startCol + Math.max(...pasteRows.map(r => r.length));
                            while (columns.length < maxColsNeeded) {
                                columns.push(`คอลัมน์ ${columns.length + 1}`);
                                columnSizes.push(DEFAULT_COLUMN_WIDTH);
                                rows.forEach(r => {
                                    while (r.length < columns.length) r.push('');
                                });
                            }
                            ensureRowWidths(); // Sync all rows

                            // Fill data
                            pasteRows.forEach((pRow, rIdx) => {
                                const targetRowIdx = startRow + rIdx;
                                if (targetRowIdx >= rows.length) return;

                                pRow.forEach((pCell, cIdx) => {
                                    const targetColIdx = startCol + cIdx;
                                    if (targetColIdx >= columns.length) return;

                                    // If first cell, append to existing content? No, overwrite usually expected in Excel paste
                                    // But here we are in a textarea. Let's overwrite for consistency.
                                    rows[targetRowIdx][targetColIdx] = pCell.trim();
                                });
                            });

                            render();
                            updatePreview();
                        });

                        input.addEventListener('blur', event => {
                            handleColumnResize(event.target);
                        });

                        // Right-click context menu
                        input.addEventListener('contextmenu', event => {
                            event.preventDefault();
                            const contextMenu = document.getElementById('tableContextMenu');
                            if (!contextMenu) return;

                            const currentRow = Number(event.target.getAttribute('data-row-index'));
                            const currentCol = Number(event.target.getAttribute('data-col-index'));

                            contextMenu.style.left = `${event.pageX}px`;
                            contextMenu.style.top = `${event.pageY}px`;
                            contextMenu.classList.add('show');
                            contextMenu.dataset.targetRow = currentRow;
                            contextMenu.dataset.targetCol = currentCol;
                            contextMenu.dataset.targetElement = `[data-row-index="${currentRow}"][data-col-index="${currentCol}"]`;
                        });
                    });

                    refs.bodyRows.querySelectorAll('.remove-row-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const rowIndex = Number(btn.getAttribute('data-remove-row'));
                            if (!Number.isInteger(rowIndex)) return;
                            if (rows.length <= 1) {
                                rows[0] = new Array(columns.length).fill('');
                                rowSizes[0] = DEFAULT_ROW_HEIGHT;
                            } else {
                                rows.splice(rowIndex, 1);
                                rowSizes.splice(rowIndex, 1);
                            }
                            render();
                            updatePreview();
                        });
                    });

                    refs.bodyRows.querySelectorAll('.row-resizer').forEach(handle => {
                        handle.addEventListener('mousedown', (e) => {
                            const rowIndex = Number(handle.getAttribute('data-resize-row'));
                            if (!Number.isInteger(rowIndex)) return;
                            e.preventDefault();
                            startRowResize(rowIndex, e.clientY);
                        });
                    });

                    rows.forEach((_, rowIndex) => {
                        applyRowHeightToElements(rowIndex);
                    });

                    refs.bodyRows.querySelectorAll('td[data-col-index]').forEach(cell => {
                        const textarea = cell.querySelector('.table-cell-input');
                        if (!textarea) return;
                        cell.addEventListener('click', (e) => {
                            if (e.target !== textarea) {
                                textarea.focus();
                                const len = textarea.value.length;
                                textarea.setSelectionRange(len, len);
                            }
                        });
                    });
                };

                const render = () => {
                    renderHeader();
                    renderBody();
                    clampActiveCell();
                    highlightActiveCell();
                    updatePreview();
                };

                const addColumn = () => {
                    columns.push(`คอลัมน์ ${columns.length + 1}`);
                    rows.forEach(row => row.push(''));
                    columnSizes.push(DEFAULT_COLUMN_WIDTH);
                    render();
                    updatePreview();
                };

                const addRow = () => {
                    const newRow = new Array(columns.length).fill('');
                    rows.push(newRow);
                    rowSizes.push(DEFAULT_ROW_HEIGHT);
                    render();
                    setTimeout(() => {
                        const lastInput = refs.bodyRows?.querySelector('tr:last-child .table-cell-input');
                        if (lastInput) lastInput.focus();
                    }, 0);
                    updatePreview();
                };

                const clear = () => {
                    columns = ['คอลัมน์ 1', 'คอลัมน์ 2'];
                    rows = [
                        ['', ''],
                        ['', ''],
                        ['', '']
                    ];
                    columnSizes = new Array(columns.length).fill(DEFAULT_COLUMN_WIDTH);
                    rowSizes = new Array(rows.length).fill(DEFAULT_ROW_HEIGHT);
                    render();
                    updatePreview();
                    if (refs.hiddenInput) {
                        refs.hiddenInput.value = '';
                    }
                };

                const sanitizeRows = (dataRows) => {
                    if (!Array.isArray(dataRows)) return [];
                    return dataRows
                        .map(row => {
                            if (!Array.isArray(row)) return new Array(columns.length).fill('');
                            const normalized = row.map(cell => {
                                if (cell === null || cell === undefined) return '';
                                return String(cell).replace(/\r\n/g, '\n');
                            });
                            while (normalized.length < columns.length) {
                                normalized.push('');
                            }
                            if (normalized.length > columns.length) {
                                normalized.length = columns.length;
                            }
                            return normalized;
                        })
                        .filter(row => row.some(cell => cell.trim() !== ''));
                };

                const syncColumnSizesLength = () => {
                    if (columnSizes.length < columns.length) {
                        columnSizes = columnSizes.concat(new Array(columns.length - columnSizes.length).fill(DEFAULT_COLUMN_WIDTH));
                    } else if (columnSizes.length > columns.length) {
                        columnSizes.length = columns.length;
                    }
                };

                const syncRowSizesLength = () => {
                    if (rowSizes.length < rows.length) {
                        rowSizes = rowSizes.concat(new Array(rows.length - rowSizes.length).fill(DEFAULT_ROW_HEIGHT));
                    } else if (rowSizes.length > rows.length) {
                        rowSizes.length = rows.length;
                    }
                };

                const getStoredColumnWidth = (colIndex) => {
                    const stored = columnSizes[colIndex];
                    if (typeof stored === 'number' && stored > 0) {
                        return Math.max(stored, MIN_COLUMN_WIDTH);
                    }
                    return DEFAULT_COLUMN_WIDTH;
                };

                const getStoredRowHeight = (rowIndex) => {
                    const stored = rowSizes[rowIndex];
                    if (typeof stored === 'number' && stored > 0) {
                        return Math.max(stored, MIN_ROW_HEIGHT);
                    }
                    return DEFAULT_ROW_HEIGHT;
                };

                const renderColGroup = () => {
                    if (!refs.colGroup) return;
                    const colsHtml = [
                        `<col class="col-row-number" data-col-type="row-number" style="width:48px;min-width:48px;max-width:48px;">`,
                        ...columns.map((_, index) => {
                            const width = getStoredColumnWidth(index);
                            return `<col data-col-index="${index}" style="width:${width}px;min-width:${MIN_COLUMN_WIDTH}px;">`;
                        }),
                        `<col class="col-actions" data-col-type="actions" style="width:56px;min-width:56px;max-width:56px;">`
                    ];
                    refs.colGroup.innerHTML = colsHtml.join('');
                };

                const fitRowHeight = (rowIndex) => {
                    if (!refs.bodyRows || !Number.isInteger(rowIndex)) return;
                    const textareas = refs.bodyRows.querySelectorAll(`.table-cell-input[data-row-index="${rowIndex}"]`);
                    if (!textareas.length) return;
                    let maxHeight = Math.max(MIN_ROW_HEIGHT, getStoredRowHeight(rowIndex));

                    textareas.forEach(textarea => {
                        textarea.style.height = 'auto';
                        const nextHeight = Math.max(MIN_ROW_HEIGHT, Math.ceil(textarea.scrollHeight + 6));
                        maxHeight = Math.max(maxHeight, nextHeight);
                    });

                    rowSizes[rowIndex] = maxHeight;
                    textareas.forEach(textarea => {
                        textarea.style.height = `${maxHeight}px`;
                    });
                    applyRowHeightToElements(rowIndex);
                };

                const fitAllRows = () => {
                    rows.forEach((_, rowIndex) => fitRowHeight(rowIndex));
                };

                const applyColumnWidthToElements = (colIndex) => {
                    const width = getStoredColumnWidth(colIndex);
                    const px = `${width}px`;
                    if (refs.headerRow) {
                        refs.headerRow.querySelectorAll(`th[data-col-index="${colIndex}"]`).forEach(th => {
                            th.style.width = px;
                            th.style.minWidth = `${MIN_COLUMN_WIDTH}px`;
                        });
                        refs.headerRow.querySelectorAll(`.table-header-input[data-col-index="${colIndex}"]`).forEach(input => {
                            input.style.width = '100%';
                        });
                    }
                    if (refs.bodyRows) {
                        refs.bodyRows.querySelectorAll(`td[data-col-index="${colIndex}"]`).forEach(td => {
                            td.style.width = px;
                            td.style.minWidth = `${MIN_COLUMN_WIDTH}px`;
                        });
                        refs.bodyRows.querySelectorAll(`.table-cell-input[data-col-index="${colIndex}"]`).forEach(textarea => {
                            textarea.style.width = '100%';
                        });
                    }
                    if (refs.colGroup) {
                        const colEl = refs.colGroup.querySelector(`col[data-col-index="${colIndex}"]`);
                        if (colEl) {
                            colEl.style.width = px;
                            colEl.style.minWidth = `${MIN_COLUMN_WIDTH}px`;
                        }
                    }
                };

                const applyRowHeightToElements = (rowIndex) => {
                    const height = getStoredRowHeight(rowIndex);
                    const px = `${height}px`;
                    if (refs.bodyRows) {
                        refs.bodyRows.querySelectorAll(`.table-cell-input[data-row-index="${rowIndex}"]`).forEach(textarea => {
                            textarea.style.height = px;
                        });
                        const rowNumber = refs.bodyRows.querySelector(`.row-number-cell[data-row-index="${rowIndex}"]`);
                        if (rowNumber) {
                            rowNumber.style.height = px;
                        }
                        const rowActions = refs.bodyRows.querySelector(`tr[data-row-index="${rowIndex}"] .table-actions-col`);
                        if (rowActions) {
                            rowActions.style.height = px;
                        }
                    }
                };

                const handleColumnResize = (element) => {
                    if (!element || !element.classList || !element.classList.contains('table-cell-input')) return;
                    const colIndex = Number(element.getAttribute('data-col-index'));
                    if (!Number.isInteger(colIndex)) return;
                    requestAnimationFrame(() => {
                        const cell = element.closest('td');
                        const rect = (cell || element).getBoundingClientRect();
                        const width = Math.max(rect.width, MIN_COLUMN_WIDTH);
                        columnSizes[colIndex] = width;
                        applyColumnWidthToElements(colIndex);
                    });
                };

                let isColResizing = false;
                let resizeStartX = 0;
                let resizeStartWidth = 0;
                let resizeColIndex = null;

                let isRowResizing = false;
                let resizeStartY = 0;
                let resizeStartHeight = 0;
                let resizeRowIndex = null;

                const startColumnResize = (colIndex, startX) => {
                    if (!Number.isInteger(colIndex)) return;
                    isColResizing = true;
                    resizeStartX = startX;
                    resizeColIndex = colIndex;
                    resizeStartWidth = getStoredColumnWidth(colIndex);
                    document.body.style.userSelect = 'none';
                };

                const startRowResize = (rowIndex, startY) => {
                    if (!Number.isInteger(rowIndex)) return;
                    isRowResizing = true;
                    resizeStartY = startY;
                    resizeRowIndex = rowIndex;
                    resizeStartHeight = getStoredRowHeight(rowIndex);
                    document.body.style.userSelect = 'none';
                };

                const onMouseMove = (event) => {
                    if (isColResizing && resizeColIndex !== null) {
                        const delta = event.clientX - resizeStartX;
                        const newWidth = Math.max(MIN_COLUMN_WIDTH, resizeStartWidth + delta);
                        columnSizes[resizeColIndex] = newWidth;
                        applyColumnWidthToElements(resizeColIndex);
                    }
                    if (isRowResizing && resizeRowIndex !== null) {
                        const deltaY = event.clientY - resizeStartY;
                        const newHeight = Math.max(MIN_ROW_HEIGHT, resizeStartHeight + deltaY);
                        rowSizes[resizeRowIndex] = newHeight;
                        applyRowHeightToElements(resizeRowIndex);
                    }
                };

                const stopResizing = () => {
                    if (isColResizing || isRowResizing) {
                        isColResizing = false;
                        isRowResizing = false;
                        resizeColIndex = null;
                        resizeRowIndex = null;
                        document.body.style.userSelect = '';
                    }
                    document.body.style.userSelect = '';
                };

                const getPayload = () => {
                    ensureColumnDefaults();
                    ensureRowWidths();
                    const sanitizedColumns = columns.map(col => col.trim());
                    const sanitizedRows = sanitizeRows(rows);
                    return {
                        columns: sanitizedColumns,
                        rows: sanitizedRows
                    };
                };

                const commit = () => {
                    if (!refs.hiddenInput) return { success: false, message: 'ไม่พบข้อมูลตาราง' };
                    const payload = getPayload();

                    const hasColumn = payload.columns.some(col => col !== '');
                    if (!hasColumn) {
                        return { success: false, message: 'กรุณาตั้งชื่อคอลัมน์อย่างน้อย 1 คอลัมน์' };
                    }

                    refs.hiddenInput.value = JSON.stringify(payload);
                    return { success: true, payload };
                };

                const populate = (data) => {
                    if (!data || typeof data !== 'object') {
                        clear();
                        return;
                    }

                    if (Array.isArray(data.columns) && data.columns.length) {
                        columns = data.columns.map(col => String(col || ''));
                    } else {
                        columns = ['คอลัมน์ 1', 'คอลัมน์ 2'];
                    }
                    columnSizes = new Array(columns.length).fill(DEFAULT_COLUMN_WIDTH);

                    if (Array.isArray(data.rows) && data.rows.length) {
                        rows = data.rows.map(row => {
                            if (Array.isArray(row)) {
                                return row.map(cell => String(cell ?? '').replace(/\r\n/g, '\n'));
                            }
                            if (row && typeof row === 'object') {
                                return columns.map(col => String(row[col] ?? '').replace(/\r\n/g, '\n'));
                            }
                            return new Array(columns.length).fill('');
                        });
                    } else {
                        rows = [new Array(columns.length).fill('')];
                    }

                    rowSizes = new Array(rows.length).fill(DEFAULT_ROW_HEIGHT);
                    ensureColumnDefaults();
                    ensureRowWidths();
                    render();
                    updatePreview();
                };

                return {
                    init() {
                        refs.colGroup = document.getElementById('tableColGroup');
                        refs.headerRow = document.getElementById('tableHeaderRow');
                        refs.bodyRows = document.getElementById('tableBodyRows');
                        refs.addColumnBtn = document.getElementById('addColumnBtn');
                        refs.addRowBtn = document.getElementById('addRowBtn');
                        refs.clearBtn = document.getElementById('clearTableBtn');
                        refs.hiddenInput = document.getElementById('tableDataInput');

                        if (!refs.headerRow || !refs.bodyRows) {
                            return;
                        }

                        if (!isInitialized) {
                            document.addEventListener('mousemove', onMouseMove);
                            document.addEventListener('mouseup', stopResizing);

                            if (refs.addColumnBtn) {
                                refs.addColumnBtn.addEventListener('click', addColumn);
                            }
                            if (refs.addRowBtn) {
                                refs.addRowBtn.addEventListener('click', addRow);
                            }
                            if (refs.clearBtn) {
                                refs.clearBtn.addEventListener('click', () => {
                                    if (confirm('ต้องการล้างข้อมูลตารางทั้งหมดหรือไม่?')) {
                                        clear();
                                    }
                                });
                            }
                            isInitialized = true;
                        }

                        syncColumnSizesLength();
                        renderColGroup();
                        render();
                        updatePreview();
                    },
                    reset() {
                        clear();
                    },
                    populateFromExisting(data) {
                        populate(data);
                    },
                    commitToHiddenInput() {
                        return commit();
                    },
                    getPayload() {
                        return getPayload();
                    },
                    addRow() {
                        addRow();
                    },
                    getActiveCell() {
                        return activeCell;
                    }
                };
            })();

            function showAlert(message, type = 'info') {
                const existingToast = document.querySelector('.notification-toast');
                if (existingToast) existingToast.remove();

                const toast = document.createElement('div');
                toast.className = `notification-toast alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
                toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1055;
                max-width: 360px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
                toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'} me-2"></i>
                    <span>${message}</span>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.classList.add('hide');
                    setTimeout(() => toast.remove(), 200);
                }, 4000);
            }

            let cellFlyout = null;
            let flyoutTarget = null;
            function ensureCellFlyout() {
                if (cellFlyout) return cellFlyout;
                const wrapper = document.createElement('div');
                wrapper.className = 'cell-flyout';
                wrapper.style.display = 'none';
                const input = document.createElement('textarea');
                input.className = 'cell-flyout-input';
                wrapper.appendChild(input);
                document.body.appendChild(wrapper);
                cellFlyout = { wrapper, input };

                input.addEventListener('input', () => {
                    if (!flyoutTarget) return;
                    flyoutTarget.value = input.value;
                    // ส่ง event ต่อให้ input หลักจัดการอัปเดต state/preview
                    flyoutTarget.dispatchEvent(new Event('input', { bubbles: true }));
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        hideCellFlyout();
                        flyoutTarget?.focus();
                    }
                });

                input.addEventListener('blur', () => {
                    hideCellFlyout();
                });

                return cellFlyout;
            }

            function hideCellFlyout() {
                if (cellFlyout) {
                    cellFlyout.wrapper.style.display = 'none';
                }
                flyoutTarget = null;
            }

            function showCellFlyout(textarea) {
                if (!textarea) return;
                const flyout = ensureCellFlyout();
                flyoutTarget = textarea;
                const rect = textarea.getBoundingClientRect();
                const scrollTop = window.scrollY || document.documentElement.scrollTop;
                const scrollLeft = window.scrollX || document.documentElement.scrollLeft;
                const width = Math.min(Math.max(rect.width, 260), 520);
                const maxHeight = 320;

                flyout.wrapper.style.width = `${width}px`;
                flyout.wrapper.style.left = `${rect.left + scrollLeft}px`;
                flyout.wrapper.style.top = `${rect.top + scrollTop}px`;
                flyout.wrapper.style.display = 'block';

                flyout.input.value = textarea.value || '';
                flyout.input.style.height = 'auto';
                flyout.input.style.height = `${Math.min(Math.max(flyout.input.scrollHeight, 80), maxHeight)}px`;
                flyout.input.focus();
                flyout.input.setSelectionRange(flyout.input.value.length, flyout.input.value.length);
            }

            function updatePreview() {
                const setChipText = (element, text) => {
                    if (!element) return;
                    const label = element.querySelector('span:last-child');
                    if (label) {
                        label.textContent = text;
                    } else {
                        element.textContent = text;
                    }
                };

                const statusChip = document.getElementById('tableStatusSummary');
                const selectionChip = document.getElementById('tableSelectionSummary');

                const columnCount = document.querySelectorAll('#tableHeaderRow th[data-col-index]').length;
                const rowCount = document.querySelectorAll('#tableBodyRows tr').length;
                setChipText(statusChip, `${columnCount} คอลัมน์ • ${rowCount} แถว`);

                const activeCell = instructionTableBuilder.getActiveCell ? instructionTableBuilder.getActiveCell() : null;
                if (activeCell && Number.isInteger(activeCell.row) && Number.isInteger(activeCell.col)) {
                    setChipText(selectionChip, `เซลล์ R${activeCell.row + 1}C${activeCell.col + 1}`);
                } else {
                    setChipText(selectionChip, 'คลิกเซลล์เพื่อแก้ไข');
                }
            }

            function copyTableAsTSV() {
                if (!instructionTableBuilder || !instructionTableBuilder.getPayload) return;
                const payload = instructionTableBuilder.getPayload();
                if (!payload || !Array.isArray(payload.columns)) return;

                const cleanValue = (value) => {
                    if (value === null || value === undefined) return '';
                    return String(value).replace(/\t/g, ' ').replace(/\r?\n/g, ' ');
                };

                const rows = payload.rows || [];
                const lines = [
                    payload.columns.map(cleanValue).join('\t'),
                    ...rows.map(row => row.map(cleanValue).join('\t'))
                ].filter(Boolean);

                const tsv = lines.join('\n');
                navigator.clipboard.writeText(tsv)
                    .then(() => showAlert('คัดลอกเป็น TSV แล้ว', 'success'))
                    .catch(() => showAlert('ไม่สามารถคัดลอกข้อมูลได้', 'error'));
            }

            function updateCharCount() {
                const counter = document.getElementById('contentCharCount');
                if (!counter) return;
                const value = document.getElementById('instructionContent').value || '';
                counter.textContent = `${value.length} อักขระ`;
            }

            document.addEventListener('DOMContentLoaded', () => {
                window.addEventListener('scroll', hideCellFlyout, true);
                window.addEventListener('resize', hideCellFlyout);

                const params = new URLSearchParams(window.location.search);
                const errorMessage = params.get('error');
                if (errorMessage) {
                    showAlert(errorMessage, 'error');
                }
                const successMessage = params.get('success');
                if (successMessage) {
                    showAlert(successMessage, 'success');
                }

                const typeSelect = document.getElementById('instructionType');
                const textSection = document.getElementById('textEditorSection');
                const tableSection = document.getElementById('tableEditorSection');
                const contentInput = document.getElementById('instructionContent');
                const titleInput = document.getElementById('instructionTitle');

                const toggleEditorSection = () => {
                    const type = typeSelect ? typeSelect.value : 'text';
                    if (type === 'table') {
                        textSection.style.display = 'none';
                        tableSection.style.display = '';
                        instructionTableBuilder.init();
                        seedInitialTableData();
                        updatePreview();
                    } else {
                        textSection.style.display = '';
                        tableSection.style.display = 'none';
                        updatePreview();
                    }
                };

                const tableDataInput = document.getElementById('tableDataInput');
                const seedInitialTableData = () => {
                    if (
                        tableDataInput &&
                        initialInstruction.type === 'table' &&
                        initialInstruction.data &&
                        !tableDataInput.value
                    ) {
                        tableDataInput.value = JSON.stringify(initialInstruction.data);
                    }
                };

                instructionTableBuilder.init();

                if (initialInstruction.type === 'table' && initialInstruction.data) {
                    instructionTableBuilder.populateFromExisting(initialInstruction.data);
                    seedInitialTableData();
                }

                toggleEditorSection();
                updateCharCount();
                updatePreview();

                if (typeSelect && typeSelect.tagName === 'SELECT') {
                    typeSelect.addEventListener('change', () => {
                        toggleEditorSection();
                        updatePreview();
                    });
                }

                contentInput.addEventListener('input', () => {
                    updateCharCount();
                    updatePreview();
                });

                const quickAddRowBtn = document.getElementById('quickAddRowBtn');
                if (quickAddRowBtn) {
                    quickAddRowBtn.addEventListener('click', () => {
                        instructionTableBuilder.addRow();
                    });
                }

                const copyTsvBtn = document.getElementById('copyTsvBtn');
                if (copyTsvBtn) {
                    copyTsvBtn.addEventListener('click', () => {
                        copyTableAsTSV();
                    });
                }

                // Context menu handlers
                const contextMenu = document.getElementById('tableContextMenu');
                if (contextMenu) {
                    document.addEventListener('click', () => {
                        contextMenu.classList.remove('show');
                    });

                    contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const action = item.dataset.action;
                            const targetRow = Number(contextMenu.dataset.targetRow);
                            const targetCol = Number(contextMenu.dataset.targetCol);
                            const targetElement = document.querySelector(`.table-cell-input${contextMenu.dataset.targetElement}`);

                            if (targetElement && !isNaN(targetRow) && !isNaN(targetCol)) {
                                if (action === 'copy') {
                                    const value = targetElement.value;
                                    copiedCellData = value;
                                    navigator.clipboard.writeText(value).catch(() => { });
                                    showAlert('คัดลอกแล้ว', 'success');
                                } else if (action === 'cut') {
                                    const value = targetElement.value;
                                    copiedCellData = value;
                                    navigator.clipboard.writeText(value).catch(() => { });
                                    targetElement.value = '';
                                    const rows = instructionTableBuilder.getPayload().rows;
                                    showAlert('ตัดแล้ว', 'success');
                                } else if (action === 'paste') {
                                    if (copiedCellData !== null) {
                                        targetElement.value = copiedCellData;
                                        targetElement.dispatchEvent(new Event('input'));
                                        showAlert('วางแล้ว', 'success');
                                    }
                                } else if (action === 'delete') {
                                    targetElement.value = '';
                                    targetElement.dispatchEvent(new Event('input'));
                                    showAlert('ล้างเซลล์แล้ว', 'success');
                                }
                            }
                            contextMenu.classList.remove('show');
                        });
                    });
                }

                // Shortcuts help button
                const shortcutsHelpBtn = document.getElementById('shortcutsHelpBtn');
                const shortcutsTooltip = document.getElementById('shortcutsTooltip');
                if (shortcutsHelpBtn && shortcutsTooltip) {
                    shortcutsHelpBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        shortcutsTooltip.classList.toggle('show');
                    });
                    document.addEventListener('click', () => {
                        shortcutsTooltip.classList.remove('show');
                    });
                    shortcutsTooltip.addEventListener('click', (e) => e.stopPropagation());
                }

                document.getElementById('editDataItemForm').addEventListener('submit', async (event) => {
                    const type = typeSelect ? typeSelect.value : 'text';
                    if (type === 'table') {
                        const result = instructionTableBuilder.commitToHiddenInput();
                        if (!result.success) {
                            event.preventDefault();
                            showAlert(result.message || 'ไม่สามารถบันทึกข้อมูลตารางได้', 'warning');
                            return false;
                        }
                        if (contentInput) {
                            contentInput.value = '';
                        }
                    } else {
                        const hidden = document.getElementById('tableDataInput');
                        if (hidden) {
                            hidden.value = '';
                        }
                    }
                    return true;
                });
            });
        </script>
</body>

</html>
